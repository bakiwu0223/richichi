<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>77ÂØåÂ©ÜË®àÂäÉ V9.0</title>
    
    <!-- React & Libraries -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --morandi-pink: #dcb5bb;
            --morandi-bg: #f7f5f4;
            --morandi-text: #5e5a5a;
            --morandi-sub: #9e9a99;
            --morandi-blue: #a6b4c3;
            --morandi-green: #b5c4b1;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--morandi-bg);
            color: var(--morandi-text);
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
            overscroll-behavior-y: none;
        }

        .text-m-pink { color: var(--morandi-pink); }
        .text-m-text { color: var(--morandi-text); }
        .text-m-sub { color: var(--morandi-sub); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .page-transition { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        input, select {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            transition: all 0.2s;
        }
        input:focus, select:focus {
            background-color: #fff;
            border-color: var(--morandi-pink);
            outline: none;
            box-shadow: 0 0 0 2px rgba(220, 181, 187, 0.2);
        }
        
        .custom-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #dcb5bb;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        .custom-checkbox:checked {
            background-color: #dcb5bb;
        }
        .custom-checkbox:checked::after {
            content: '‚úì';
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icon = ({ name, size = 20, className = "" }) => <i data-lucide={name} width={size} height={size} className={className}></i>;
        
        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-[24px] p-6 shadow-[0_4px_20px_-10px_rgba(0,0,0,0.05)] border border-stone-50 ${className}`}>{children}</div>
        );

        const safeStorage = {
            get: (key, fallback) => { try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : fallback; } catch (e) { return fallback; } },
            set: (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {} }
        };

        // --- Custom Confirm Modal ---
        const CustomConfirmModal = ({ isOpen, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[60] flex items-center justify-center p-6 animate-in fade-in duration-200">
                    <div className="bg-white rounded-[24px] p-6 w-full max-w-xs shadow-2xl scale-100 animate-in zoom-in-95 duration-200">
                        <div className="text-center mb-6">
                            <div className="mx-auto w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-3 text-red-500">
                                <Icon name="alert-triangle" size={24}/>
                            </div>
                            <h3 className="text-lg font-bold text-gray-800 mb-2">Á¢∫Ë™çÂà™Èô§Ôºü</h3>
                            <p className="text-sm text-gray-500 leading-relaxed">{message}</p>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 py-3 rounded-xl bg-gray-100 text-gray-600 font-bold text-sm hover:bg-gray-200 transition-colors">ÂèñÊ∂à</button>
                            <button onClick={onConfirm} className="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold text-sm shadow-md shadow-red-200 hover:bg-red-600 transition-colors">Âà™Èô§</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Charts ---
        const StackedBarChart = ({ data }) => {
            if (!data || data.length === 0) return <div className="text-m-sub text-center py-10 text-xs font-light tracking-widest">NO DATA YET</div>;
            const maxTotal = Math.max(...data.map(d => d.total)) || 1;
            const displayData = data.slice(0, 6).reverse(); 
            return (
                <div className="flex items-end justify-between h-40 pt-4 px-2 space-x-3 select-none">
                    {displayData.map((d, i) => {
                        const hCash = (d.cash / maxTotal) * 100;
                        const hEtf = (d.etf / maxTotal) * 100;
                        const hRepay = (d.repay / maxTotal) * 100;
                        return (
                            <div key={i} className="flex flex-col items-center flex-1 group relative">
                                <div className="w-full max-w-[32px] flex flex-col-reverse h-28 bg-[#f0f0f0] rounded-full overflow-hidden relative">
                                    <div style={{height: `${hRepay}%`}} className="bg-[#dcb5bb] w-full transition-all duration-500"></div>
                                    <div style={{height: `${hEtf}%`}} className="bg-[#a6b4c3] w-full transition-all duration-500"></div>
                                    <div style={{height: `${hCash}%`}} className="bg-[#b5c4b1] w-full transition-all duration-500"></div>
                                </div>
                                <div className="text-[10px] text-m-sub mt-2 font-medium tracking-wide">{d.month.split('-')[1]}Êúà</div>
                            </div>
                        )
                    })}
                </div>
            );
        };

        const SimplePieChart = ({ data }) => {
            if (!data || data.length === 0) return <div className="text-m-sub text-center py-10 text-xs font-light tracking-widest">NO DATA</div>;
            const total = data.reduce((acc, item) => acc + item.value, 0);
            let cumulativePercent = 0;
            const palette = ['#dcb5bb', '#eaddcf', '#a6b4c3', '#b5c4b1', '#c7c7bb', '#d8d3cd', '#bfb5b2', '#9fa3a7'];
            const slices = data.map((slice, index) => {
                const startPercent = cumulativePercent;
                const slicePercent = slice.value / total;
                cumulativePercent += slicePercent;
                const endPercent = cumulativePercent;
                const x1 = Math.cos(2 * Math.PI * startPercent);
                const y1 = Math.sin(2 * Math.PI * startPercent);
                const x2 = Math.cos(2 * Math.PI * endPercent);
                const y2 = Math.sin(2 * Math.PI * endPercent);
                const largeArcFlag = slicePercent > 0.5 ? 1 : 0;
                const pathData = [`M 0 0`, `L ${x1} ${y1}`, `A 1 1 0 ${largeArcFlag} 1 ${x2} ${y2}`, `L 0 0`].join(' ');
                return <path d={pathData} fill={palette[index % palette.length]} key={index} stroke="#fff" strokeWidth="0.05" />;
            });
            return (
                <div className="flex flex-col items-center">
                    <div className="w-36 h-36 relative drop-shadow-sm">
                        <svg viewBox="-1 -1 2 2" style={{ transform: 'rotate(-90deg)' }}>{slices}</svg>
                    </div>
                    <div className="mt-6 grid grid-cols-2 gap-x-4 gap-y-2 w-full text-xs">
                        {data.map((item, index) => (
                            <div key={index} className="flex items-center justify-between">
                                <div className="flex items-center">
                                    <span className="w-2 h-2 rounded-full mr-2" style={{backgroundColor: palette[index % palette.length]}}></span>
                                    <span className="text-m-text truncate max-w-[80px]">{item.name}</span>
                                </div>
                                <span className="font-medium text-m-text">${item.value.toLocaleString()}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- NEW: Category Manager Modal ---
        const CategoryManagerModal = ({ categories, onClose, onUpdateCategories }) => {
            const [newCategory, setNewCategory] = useState('');
            const [editIndex, setEditIndex] = useState(-1);
            const [editValue, setEditValue] = useState('');
            const [deleteTarget, setDeleteTarget] = useState(null);

            const handleAdd = () => {
                if (newCategory && !categories.includes(newCategory)) {
                    onUpdateCategories([...categories, newCategory]);
                    setNewCategory('');
                }
            };

            const startEdit = (index, value) => {
                setEditIndex(index);
                setEditValue(value);
            };

            const saveEdit = () => {
                if (editValue) {
                    const newCats = [...categories];
                    newCats[editIndex] = editValue;
                    onUpdateCategories(newCats);
                    setEditIndex(-1);
                }
            };

            const confirmDelete = () => {
                if (deleteTarget !== null) {
                    const newCats = categories.filter((_, i) => i !== deleteTarget);
                    onUpdateCategories(newCats);
                    setDeleteTarget(null);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <CustomConfirmModal 
                        isOpen={deleteTarget !== null}
                        message="Á¢∫ÂÆöÂà™Èô§Ê≠§ÂàÜÈ°ûÂóéÔºüÊ≠∑Âè≤Ë®òÂ∏≥Ë≥áÊñô‰∏çÊúÉÂèóÂΩ±Èüø„ÄÇ"
                        onConfirm={confirmDelete}
                        onCancel={() => setDeleteTarget(null)}
                    />
                    <div className="bg-white rounded-[32px] p-6 w-full max-w-sm shadow-2xl animate-in fade-in zoom-in duration-200">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-m-text">ÂàÜÈ°ûÁÆ°ÁêÜ</h3>
                            <button onClick={onClose} className="text-gray-400 p-1"><Icon name="x" size={24}/></button>
                        </div>

                        <div className="mb-4 max-h-60 overflow-y-auto no-scrollbar space-y-2">
                            {categories.map((cat, idx) => (
                                <div key={idx} className="flex justify-between items-center p-3 rounded-xl bg-gray-50">
                                    {editIndex === idx ? (
                                        <div className="flex gap-2 w-full">
                                            <input type="text" className="flex-1 rounded-lg px-2 py-1 text-sm" value={editValue} onChange={(e)=>setEditValue(e.target.value)} />
                                            <button onClick={saveEdit} className="text-green-500"><Icon name="check" size={18}/></button>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="text-sm font-bold text-m-text">{cat}</div>
                                            <div className="flex gap-2">
                                                <button onClick={() => startEdit(idx, cat)} className="text-gray-400 hover:text-blue-400 p-1"><Icon name="pencil" size={16}/></button>
                                                <button onClick={() => setDeleteTarget(idx)} className="text-gray-300 hover:text-red-400 p-1"><Icon name="trash-2" size={16}/></button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            ))}
                        </div>

                        <div className="border-t border-dashed border-gray-200 pt-4 flex gap-2">
                            <input type="text" placeholder="Ëº∏ÂÖ•Êñ∞ÂàÜÈ°ûÂêçÁ®±" className="flex-1 rounded-xl px-4 py-2 text-sm bg-gray-50 focus:bg-white border focus:border-m-pink" value={newCategory} onChange={e => setNewCategory(e.target.value)} />
                            <button onClick={handleAdd} className="px-4 py-2 rounded-xl text-white text-sm bg-[#dcb5bb] font-bold shadow-sm">Êñ∞Â¢û</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Card Manager Modal ---
        const CardManagerModal = ({ cards, onClose, onUpdateCards }) => {
            const [form, setForm] = useState({ id: '', name: '', stmtDay: '', dueDay: '' });
            const [isEditing, setIsEditing] = useState(false);
            const [deleteTargetId, setDeleteTargetId] = useState(null);

            const handleEdit = (card) => { setForm(card); setIsEditing(true); };
            const requestDelete = (id) => { setDeleteTargetId(id); };
            const confirmDelete = () => {
                if (deleteTargetId) {
                    const newCards = cards.filter(c => c.id !== deleteTargetId);
                    onUpdateCards(newCards);
                    if (isEditing && form.id === deleteTargetId) {
                        setForm({ id: '', name: '', stmtDay: '', dueDay: '' });
                        setIsEditing(false);
                    }
                    setDeleteTargetId(null);
                }
            };

            const handleSubmit = () => {
                if(!form.name) return;
                if (isEditing) { 
                    const updatedCards = cards.map(c => c.id === form.id ? { ...c, ...form } : c);
                    onUpdateCards(updatedCards); 
                } else { 
                    const newCard = { id: Date.now().toString(), ...form, stmtDay: form.stmtDay || '-', dueDay: form.dueDay || '-' }; 
                    onUpdateCards([...cards, newCard]); 
                }
                setForm({ id: '', name: '', stmtDay: '', dueDay: '' }); 
                setIsEditing(false);
            };
            
            const handleCancelEdit = () => { setForm({ id: '', name: '', stmtDay: '', dueDay: '' }); setIsEditing(false); };

            return (
                <div className="fixed inset-0 bg-black/20 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <CustomConfirmModal 
                        isOpen={!!deleteTargetId}
                        message="Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂºµÂç°ÁâáÂóéÔºüÁõ∏ÈóúÁöÑË®òÂ∏≥Ë≥áÊñôÈõñÁÑ∂ÊúÉ‰øùÁïôÔºå‰ΩÜÁØ©ÈÅ∏Âô®ÈÅ∏È†ÖÂ∞áÊúÉÊ∂àÂ§±„ÄÇ"
                        onConfirm={confirmDelete}
                        onCancel={() => setDeleteTargetId(null)}
                    />
                    <div className="bg-white rounded-[32px] p-6 w-full max-w-sm shadow-2xl animate-in fade-in zoom-in duration-200">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-m-text">{isEditing ? 'Á∑®ËºØÂç°Áâá' : 'Âç°ÁâáÁÆ°ÁêÜ'}</h3>
                            <button onClick={onClose} className="text-gray-400 p-1"><Icon name="x" size={24}/></button>
                        </div>
                        <div className="mb-4 max-h-60 overflow-y-auto no-scrollbar space-y-2">
                            {cards.map(c => (
                                <div key={c.id} className={`flex items-center justify-between p-3 rounded-xl border transition-all ${isEditing && form.id === c.id ? 'bg-[#dcb5bb]/10 border-[#dcb5bb]' : 'bg-gray-50 border-transparent'}`}>
                                    <div className="flex-1 cursor-pointer" onClick={() => handleEdit(c)}>
                                        <div className="text-sm font-bold text-m-text">{c.name}</div>
                                        <div className="text-[10px] text-m-sub mt-0.5">ÁµêÂ∏≥ {c.stmtDay} / Áπ≥Ê¨æ {c.dueDay}</div>
                                    </div>
                                    <button type="button" className="ml-3 p-2 bg-white rounded-full shadow-sm text-gray-300 hover:text-red-500 hover:bg-red-50 transition-colors border border-gray-100" onClick={(e) => { e.stopPropagation(); requestDelete(c.id); }}><Icon name="trash-2" size={18}/></button>
                                </div>
                            ))}
                            {cards.length === 0 && <div className="text-center text-gray-400 text-xs py-4">ÁõÆÂâçÊ≤íÊúâ‰ø°Áî®Âç°</div>}
                        </div>
                        <div className={`border-t border-dashed border-gray-200 pt-4 space-y-3 ${isEditing ? 'bg-gray-50/50 -mx-2 px-2 pb-2 rounded-xl border-t-0' : ''}`}>
                            <div className="flex justify-between items-center mb-1">
                                <label className="text-[10px] text-m-sub font-bold uppercase tracking-wider">{isEditing ? 'Editing Info' : 'New Card Info'}</label>
                                {isEditing && <span className="text-[10px] text-m-pink font-bold">‰øÆÊîπÊ®°Âºè</span>}
                            </div>
                            <input type="text" placeholder="Âç°ÁâáÂêçÁ®± (e.g. ÂúãÊ≥∞Cube)" className="w-full rounded-xl px-4 py-2 text-sm bg-gray-50 focus:bg-white border focus:border-m-pink" value={form.name} onChange={e => setForm({...form, name: e.target.value})} />
                            <div className="grid grid-cols-2 gap-3">
                                <input type="text" inputMode="numeric" placeholder="ÁµêÂ∏≥Êó• (e.g. 27)" className="w-full rounded-xl px-4 py-2 text-sm bg-gray-50 focus:bg-white border focus:border-m-pink" value={form.stmtDay} onChange={e => setForm({...form, stmtDay: e.target.value})} />
                                <input type="text" inputMode="numeric" placeholder="Áπ≥Ê¨æÊó• (e.g. 15)" className="w-full rounded-xl px-4 py-2 text-sm bg-gray-50 focus:bg-white border focus:border-m-pink" value={form.dueDay} onChange={e => setForm({...form, dueDay: e.target.value})} />
                            </div>
                            <div className="flex gap-2 pt-2">
                                {isEditing ? (
                                    <><button type="button" onClick={() => requestDelete(form.id)} className="flex-1 py-2.5 rounded-xl text-red-400 text-sm bg-red-50 font-bold hover:bg-red-100 transition-colors">Âà™Èô§Ê≠§Âç°</button><button type="button" onClick={handleCancelEdit} className="flex-1 py-2.5 rounded-xl text-gray-500 text-sm bg-gray-200 font-medium hover:bg-gray-300 transition-colors">ÂèñÊ∂à</button></>
                                ) : (
                                    <button type="button" onClick={onClose} className="flex-1 py-2.5 rounded-xl text-gray-500 text-sm bg-gray-100 font-medium hover:bg-gray-200 transition-colors">ÈóúÈñâ</button>
                                )}
                                <button type="button" onClick={handleSubmit} className="flex-1 py-2.5 rounded-xl text-white text-sm bg-[#dcb5bb] hover:bg-[#d4a5a5] font-bold shadow-sm active:scale-95 transition-transform">{isEditing ? 'Á¢∫Ë™ç‰øÆÊîπ' : 'Êñ∞Â¢û'}</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const BillCheckList = ({ cards, transactions, selectedMonth, paidStatus, setPaidStatus }) => {
            const getBillInfo = (card) => {
                const stmtDay = parseInt(card.stmtDay);
                if (isNaN(stmtDay)) return { total: 0, dateRange: '', dueDate: '-' };
                const [year, month] = selectedMonth.split('-').map(Number);
                const endDate = new Date(year, month - 1, stmtDay); 
                const startDate = new Date(year, month - 2, stmtDay + 1); 
                const dueDateDisplay = `${card.dueDay}Êó•`;
                const total = transactions.filter(t => t.type !== 'lending' && t.cardId === card.id).filter(t => {
                    const txDate = new Date(t.date);
                    return txDate >= startDate && txDate <= endDate;
                }).reduce((acc, curr) => acc + parseFloat(curr.amount), 0);
                return { total, dueDateDisplay };
            };
            const togglePaid = (cardId) => {
                const key = `${cardId}_${selectedMonth}`;
                const newStatus = { ...paidStatus, [key]: !paidStatus[key] };
                setPaidStatus(newStatus);
            };
            return (
                <Card className="mt-4 mb-4">
                    <h3 className="text-sm font-bold text-m-text mb-3 tracking-wide flex items-center"><Icon name="check-square" size={16} className="mr-2 text-m-pink"/>Êú¨ÊúàÁπ≥Ê¨æÊ∏ÖÂñÆ ({selectedMonth})</h3>
                    <div className="space-y-3">
                        {cards.map(card => {
                            const { total, dueDateDisplay } = getBillInfo(card);
                            const isPaid = paidStatus[`${card.id}_${selectedMonth}`];
                            return (
                                <div key={card.id} className={`flex items-center justify-between p-3 rounded-xl border transition-all ${isPaid ? 'bg-gray-50 border-gray-100 opacity-60' : 'bg-white border-gray-100 shadow-sm'}`}>
                                    <div className="flex items-center gap-3">
                                        <input type="checkbox" className="custom-checkbox" checked={!!isPaid} onChange={() => togglePaid(card.id)} />
                                        <div><div className={`text-sm font-bold ${isPaid ? 'text-gray-400 line-through' : 'text-m-text'}`}>{card.name}</div><div className="text-[10px] text-m-sub">Áπ≥Ê¨æÊúüÈôê: {dueDateDisplay} {isPaid ? '(Â∑≤Áπ≥)' : ''}</div></div>
                                    </div>
                                    <div className={`font-bold ${isPaid ? 'text-gray-300' : 'text-m-text'}`}>${total.toLocaleString()}</div>
                                </div>
                            );
                        })}
                        {cards.length === 0 && <div className="text-center text-xs text-gray-300 py-2">Â∞öÊú™Ë®≠ÂÆö‰ø°Áî®Âç°</div>}
                    </div>
                </Card>
            );
        };

        // --- Views ---

        const HomeView = ({ stats, projection, config, setConfig, onSaveTransactions }) => {
            const [showSettings, setShowSettings] = useState(false);
            const [input, setInput] = useState({ depositCash: '', depositEtf: '', repayment: '' });
            const handleSubmit = () => {
                const newTrans = [];
                const today = new Date().toISOString().split('T')[0];
                if (input.depositCash) newTrans.push({ type: 'deposit_cash', amount: input.depositCash, note: 'ÁèæÈáëÂ≠òÂÖ•' });
                if (input.depositEtf) newTrans.push({ type: 'deposit_etf', amount: input.depositEtf, note: 'ETFÂ≠òÂÖ•' });
                if (input.repayment) newTrans.push({ type: 'repayment', amount: input.repayment, note: 'Áî∑ÂèãÈÇÑÊ¨æ' });
                if (newTrans.length > 0) { onSaveTransactions(newTrans, today); setInput({ depositCash: '', depositEtf: '', repayment: '' }); }
            };
            const handleConfigChange = (e) => setConfig({ ...config, [e.target.name]: e.target.value });
            return (
                <div className="space-y-5 pb-48 page-transition">
                    <div className="bg-[#dcb5bb] rounded-[32px] p-8 text-white shadow-sm relative overflow-hidden mx-1">
                        <div className="absolute -top-10 -right-10 w-40 h-40 bg-white opacity-10 rounded-full blur-2xl"></div>
                        <div className="relative z-10">
                            <div className="text-white/80 text-xs font-medium tracking-widest mb-1 uppercase">Total Assets</div>
                            <div className="text-4xl font-light mb-6 tracking-tight">${stats.totalAssets.toLocaleString()}</div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><div className="text-[10px] text-white/70 uppercase tracking-wider mb-1">Portfolio (ETF)</div><div className="text-lg font-medium">${stats.etfAssets.toLocaleString()}</div></div>
                                <div><div className="text-[10px] text-white/70 uppercase tracking-wider mb-1">Cash</div><div className="text-lg font-medium">${stats.cashAssets.toLocaleString()}</div></div>
                            </div>
                            <div className="mt-6 pt-4 border-t border-white/20 flex justify-between items-center"><div className="flex items-center text-white/90"><span className="text-xs mr-2">Áî∑ÂèãÊ¨†Ê¨æÁ∏ΩÈ°ç</span><span className="font-medium text-lg">${stats.currentDebt.toLocaleString()}</span></div><Icon name="heart-handshake" className="text-white/80" /></div>
                        </div>
                    </div>
                    <div className="px-2">
                         <div onClick={() => setShowSettings(!showSettings)} className="flex justify-center py-2 cursor-pointer opacity-50 hover:opacity-100 transition-opacity">{showSettings ? <Icon name="chevron-up" size={16} className="text-m-text"/> : <Icon name="grip-horizontal" size={20} className="text-m-pink"/>}</div>
                        {showSettings && (
                            <Card className="mb-4 animate-in slide-in-from-top-2 fade-in duration-300">
                                <h3 className="text-xs font-bold text-m-sub uppercase mb-4 tracking-widest text-center">Initial Settings</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="col-span-2"><label className="block text-[10px] text-m-sub mb-1 ml-1">Áî∑ÂèãÂàùÂßãÊ¨†Ê¨æ</label><input type="number" name="initialDebt" value={config.initialDebt} onChange={handleConfigChange} className="w-full rounded-xl px-4 py-2 text-sm text-m-text" inputMode="numeric"/></div>
                                    <div><label className="block text-[10px] text-m-sub mb-1 ml-1">ÂàùÂßãÁèæÈáë</label><input type="number" name="initialCash" value={config.initialCash} onChange={handleConfigChange} className="w-full rounded-xl px-4 py-2 text-sm text-m-text" inputMode="numeric"/></div>
                                    <div><label className="block text-[10px] text-m-sub mb-1 ml-1">ÂàùÂßã ETF</label><input type="number" name="initialEtf" value={config.initialEtf} onChange={handleConfigChange} className="w-full rounded-xl px-4 py-2 text-sm text-m-text" inputMode="numeric"/></div>
                                    <div className="col-span-2"><label className="block text-[10px] text-m-sub mb-1 ml-1 text-center">ETF Âπ¥ÂåñÂ†±ÈÖ¨Áéá (%)</label><input type="number" name="etfReturnRate" value={config.etfReturnRate} onChange={handleConfigChange} className="w-full rounded-xl px-4 py-2 text-sm text-m-text font-bold text-center text-[#a6b4c3]" inputMode="decimal"/></div>
                                </div>
                            </Card>
                        )}
                    </div>
                    <div className="px-1">
                        <h3 className="text-sm font-bold text-m-text mb-3 ml-2 tracking-wide">Monthly Checklist</h3>
                        <Card className="space-y-4">
                            {[{ label: 'ÁèæÈáëÂ≠òÂÖ•', icon: 'banknote', color: 'text-[#b5c4b1]', bg: 'bg-[#b5c4b1]/20', val: input.depositCash, key: 'depositCash' }, { label: 'ETF ÊäïÂÖ•', icon: 'landmark', color: 'text-[#a6b4c3]', bg: 'bg-[#a6b4c3]/20', val: input.depositEtf, key: 'depositEtf' }, { label: 'Áî∑ÂèãÈÇÑÊ¨æ', icon: 'user-minus', color: 'text-[#dcb5bb]', bg: 'bg-[#dcb5bb]/20', val: input.repayment, key: 'repayment' }].map((item, idx) => (
                                <div key={idx} className="flex items-center space-x-3">
                                    <div className={`p-2.5 rounded-xl ${item.bg} ${item.color}`}><Icon name={item.icon} size={18}/></div>
                                    <div className="flex-1"><label className="text-[10px] text-m-sub block mb-0.5">{item.label}</label><input type="number" value={item.val} onChange={(e) => setInput({...input, [item.key]: e.target.value})} className="w-full bg-transparent border-b border-dashed border-gray-300 py-1 focus:border-solid focus:border-[#dcb5bb] outline-none font-medium text-m-text rounded-none px-0" placeholder="0" inputMode="numeric"/></div>
                                </div>
                            ))}
                            <button onClick={handleSubmit} className="w-full bg-[#dcb5bb] hover:bg-[#d4a5a5] text-white py-3.5 rounded-2xl font-bold shadow-md active:scale-95 transition-all text-sm tracking-widest mt-2">SAVE ASSETS</button>
                        </Card>
                    </div>
                    <div className="fixed bottom-[80px] left-4 right-4 z-10">
                        <div className="bg-[#5e5a5a] text-white rounded-2xl p-4 shadow-xl flex justify-between items-center backdrop-blur-md bg-opacity-95">
                            <div><div className="text-[10px] text-white/50 tracking-widest uppercase">2027 Vision</div><div className="text-lg font-light tracking-wide">${projection.toLocaleString()}</div></div>
                            <div className="text-right flex flex-col items-end"><Icon name="trending-up" className="text-[#b5c4b1] mb-1" size={18}/><div className="text-[9px] text-white/40">@{config.etfReturnRate}% APY</div></div>
                        </div>
                    </div>
                </div>
            );
        };

        const ExpenseView = ({ transactions, customCategories, setCustomCategories, cards, setCards, onSaveTransaction, onDelete, paidBills, setPaidBills, onUpdateTransactions }) => {
            const [input, setInput] = useState({ id: null, amount: '', method: 'ÁèæÈáë', cardId: '', category: 'È£≤È£ü', customCategory: '', note: '', date: new Date().toISOString().split('T')[0] });
            const [isAddingCategory, setIsAddingCategory] = useState(false);
            const [isLoan, setIsLoan] = useState(false);
            const [selectedMonth, setSelectedMonth] = useState('');
            const [selectedCardFilter, setSelectedCardFilter] = useState('all');
            const [showCardManager, setShowCardManager] = useState(false);
            const [showCategoryManager, setShowCategoryManager] = useState(false);
            const [isEditingTx, setIsEditingTx] = useState(false);

            useEffect(() => { setSelectedMonth(new Date().toISOString().substring(0, 7)); }, []);
            useEffect(() => {
                if (selectedCardFilter !== 'all' && selectedCardFilter !== 'cash') {
                    const cardExists = cards.find(c => c.id === selectedCardFilter);
                    if (!cardExists) { setSelectedCardFilter('all'); }
                }
            }, [cards, selectedCardFilter]);

            const startEditTransaction = (tx) => {
                setInput({
                    id: tx.id,
                    amount: tx.amount,
                    method: tx.method || 'ÁèæÈáë',
                    cardId: tx.cardId || '',
                    category: tx.category,
                    customCategory: '',
                    note: tx.note || '',
                    date: tx.date
                });
                setIsLoan(tx.type === 'lending');
                setIsEditingTx(true);
                // Scroll to top to see form
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleSubmit = () => {
                if (!input.amount) return;
                let type = 'expense', category = input.category;
                if (isLoan) { type = 'lending'; category = 'Áî∑ÂèãÂÄüÊ¨æ'; } else { category = isAddingCategory ? input.customCategory : input.category; if (isAddingCategory && category && !customCategories.includes(category)) { setCustomCategories([...customCategories, category]); } }
                let finalCardId = input.cardId;
                if (input.method === 'Âà∑Âç°' && !finalCardId && cards.length > 0) { finalCardId = cards[0].id; }
                
                const newTx = { 
                    type, 
                    amount: input.amount, 
                    method: input.method, 
                    cardId: input.method === 'Âà∑Âç°' ? finalCardId : null, 
                    category, 
                    date: input.date, 
                    note: input.note 
                };

                if (isEditingTx && input.id) {
                    // Update existing
                    onUpdateTransactions({ ...newTx, id: input.id });
                    setIsEditingTx(false);
                } else {
                    // Add new
                    onSaveTransaction(newTx);
                }

                setInput({ id: null, amount: '', method: 'ÁèæÈáë', cardId: '', category: 'È£≤È£ü', customCategory: '', note: '', date: new Date().toISOString().split('T')[0] }); 
                setIsAddingCategory(false); 
                setIsLoan(false); 
                setSelectedMonth(input.date.substring(0, 7));
            };

            const expenseHistory = transactions.filter(t => t.type === 'expense' || t.type === 'lending');
            const availableMonths = useMemo(() => {
                const months = new Set(expenseHistory.map(t => t.date.substring(0, 7)));
                months.add(new Date().toISOString().substring(0, 7));
                return Array.from(months).sort().reverse();
            }, [expenseHistory]);
            const displayedMonth = selectedMonth || availableMonths[0];

            let filterDescription = "", filteredItems = [];
            if (selectedCardFilter === 'all' || selectedCardFilter === 'cash') {
                filterDescription = selectedCardFilter === 'all' ? 'Áï∂ÊúàÁ∏ΩÊîØÂá∫ (Ëá™ÁÑ∂Êúà)' : 'Áï∂ÊúàÁèæÈáëÊîØÂá∫';
                filteredItems = expenseHistory.filter(t => t.date.startsWith(displayedMonth) && (selectedCardFilter === 'all' ? true : t.method === 'ÁèæÈáë'));
            } else {
                const selectedCard = cards.find(c => c.id === selectedCardFilter);
                if (selectedCard) {
                    const stmtDay = parseInt(selectedCard.stmtDay);
                    if (!isNaN(stmtDay)) {
                        const [year, month] = displayedMonth.split('-').map(Number);
                        const endDate = new Date(year, month - 1, stmtDay); 
                        const startDate = new Date(year, month - 2, stmtDay + 1); 
                        const fmt = (d) => `${d.getMonth()+1}/${d.getDate()}`;
                        filterDescription = `${selectedCard.name} (${fmt(startDate)} - ${fmt(endDate)})`;
                        filteredItems = expenseHistory.filter(t => { if (t.cardId !== selectedCardFilter) return false; const txDate = new Date(t.date); return txDate >= startDate && txDate <= endDate; });
                    } else {
                        filterDescription = `${selectedCard.name} (Ëá™ÁÑ∂Êúà)`;
                        filteredItems = expenseHistory.filter(t => t.date.startsWith(displayedMonth) && t.cardId === selectedCardFilter);
                    }
                }
            }

            const currentMonthItems = filteredItems.sort((a, b) => {
                if (a.date !== b.date) { return b.date.localeCompare(a.date); }
                return b.id - a.id; 
            });
            
            const currentMonthTotal = currentMonthItems.reduce((acc, curr) => acc + parseFloat(curr.amount), 0);

            return (
                <div className="space-y-6 pb-24 page-transition px-1 pt-4">
                    <div className="flex justify-between items-center px-2">
                        <h2 className="text-xl font-bold text-m-text tracking-wide">Expenditure</h2>
                        <button onClick={() => setShowCardManager(true)} className="text-xs text-m-sub bg-white px-3 py-1.5 rounded-full shadow-sm border border-gray-100 flex items-center"><Icon name="credit-card" size={14} className="mr-1"/> Âç°ÁâáÁÆ°ÁêÜ</button>
                    </div>
                    <div className="flex overflow-x-auto pb-2 px-1 space-x-3 no-scrollbar snap-x">
                        {cards.map(card => (
                            <div key={card.id} className="min-w-[140px] bg-white p-3 rounded-2xl shadow-sm border border-gray-50 snap-center flex flex-col justify-between h-24 relative overflow-hidden group">
                                <div className="absolute top-0 right-0 w-12 h-12 bg-gray-50 rounded-bl-full -mr-2 -mt-2 z-0"></div>
                                <div className="relative z-10"><div className="text-xs font-bold text-m-text truncate">{card.name}</div></div>
                                <div className="relative z-10 grid grid-cols-2 gap-1 mt-2"><div><div className="text-[9px] text-m-sub uppercase">Stmt</div><div className="text-sm font-medium text-m-pink">{card.stmtDay}</div></div><div><div className="text-[9px] text-m-sub uppercase">Due</div><div className="text-sm font-medium text-[#a6b4c3]">{card.dueDay}</div></div></div>
                            </div>
                        ))}
                         <div onClick={() => setShowCardManager(true)} className="min-w-[50px] flex items-center justify-center bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200 cursor-pointer text-gray-400"><Icon name="plus" size={20}/></div>
                    </div>
                    {showCardManager && <CardManagerModal cards={cards} onClose={() => setShowCardManager(false)} onUpdateCards={setCards} />}
                    {showCategoryManager && <CategoryManagerModal categories={customCategories} onClose={() => setShowCategoryManager(false)} onUpdateCategories={setCustomCategories} />}
                    
                    <BillCheckList cards={cards} transactions={transactions} selectedMonth={displayedMonth} paidStatus={paidBills} setPaidStatus={setPaidBills} />
                    
                    <Card>
                        <div className="flex items-center justify-between mb-6 pb-4 border-b border-dashed border-gray-100"><span className={`text-sm font-bold ${isLoan ? 'text-m-pink' : 'text-m-sub'}`}>ÈÄôÊòØÁî∑ÂèãÂÄüÊ¨æÔºü</span><div onClick={() => setIsLoan(!isLoan)} className={`w-12 h-7 rounded-full flex items-center p-1 cursor-pointer transition-all duration-300 ${isLoan ? 'bg-[#dcb5bb]' : 'bg-gray-200'}`}><div className={`bg-white w-5 h-5 rounded-full shadow-sm transition-all duration-300 ${isLoan ? 'translate-x-5' : 'translate-x-0'}`}></div></div></div>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="col-span-2"><label className="text-[10px] text-m-sub ml-1 uppercase tracking-wider">Amount</label><div className="relative mt-1"><span className="absolute left-3 top-3 text-m-sub font-light">$</span><input type="number" className="w-full rounded-2xl py-3 pl-8 pr-4 text-xl font-medium text-m-text" value={input.amount} onChange={(e) => setInput({...input, amount: e.target.value})} placeholder="0.00" inputMode="numeric"/></div></div>
                            {!isLoan && (
                                <>
                                    <div className="col-span-2">
                                        <label className="text-[10px] text-m-sub ml-1 uppercase tracking-wider">Category</label>
                                        {isAddingCategory ? (<div className="flex gap-2 mt-1"><input type="text" className="flex-1 rounded-xl px-3 py-2 text-sm" placeholder="Ëº∏ÂÖ•ÂàÜÈ°û" value={input.customCategory} onChange={(e) => setInput({...input, customCategory: e.target.value})} /><button onClick={() => setIsAddingCategory(false)} className="bg-gray-200 text-gray-500 px-3 rounded-xl text-xs">ÂèñÊ∂à</button></div>) : (
                                            <div className="mt-1 flex gap-2">
                                                <select className="flex-1 rounded-xl px-3 py-2.5 text-sm text-m-text" value={input.category} onChange={(e) => { if (e.target.value === 'custom') { setIsAddingCategory(true); setInput({...input, customCategory: ''}); } else { setInput({...input, category: e.target.value}); } }}>{customCategories.map(c => <option key={c} value={c}>{c}</option>)}<option value="custom">+ Ëá™Ë®ÇÂàÜÈ°û</option></select>
                                                <button onClick={() => setShowCategoryManager(true)} className="px-3 bg-gray-100 rounded-xl text-m-sub"><Icon name="settings" size={16}/></button>
                                            </div>
                                        )}
                                    </div>
                                    <div><label className="text-[10px] text-m-sub ml-1 uppercase tracking-wider">Method</label><select className="w-full rounded-xl px-3 py-2 text-sm text-m-text mt-1" value={input.method} onChange={(e) => setInput({...input, method: e.target.value})}><option value="ÁèæÈáë">ÁèæÈáë</option><option value="Âà∑Âç°">Âà∑Âç°</option></select></div>
                                    {input.method === 'Âà∑Âç°' && (<div><label className="text-[10px] text-m-pink ml-1 uppercase tracking-wider font-bold">Select Card</label><select className="w-full rounded-xl px-3 py-2 text-sm text-m-text mt-1 border-[#dcb5bb]" value={input.cardId} onChange={(e) => setInput({...input, cardId: e.target.value})}><option value="" disabled>ÈÅ∏ÊìáÂç°Áâá</option>{cards.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>)}
                                </>
                            )}
                            <div className={isLoan ? "col-span-2" : ""}><label className="text-[10px] text-m-sub ml-1 uppercase tracking-wider">Date</label><input type="date" className="w-full rounded-xl px-3 py-2 text-sm text-m-text mt-1" value={input.date} onChange={(e) => setInput({...input, date: e.target.value})} /></div>
                        </div>
                        <div className="mb-4"><input type="text" placeholder="Add a note..." className="w-full bg-transparent border-b border-gray-100 py-2 text-sm text-m-text placeholder-gray-300 focus:border-[#dcb5bb] outline-none" value={input.note} onChange={(e) => setInput({...input, note: e.target.value})} /></div>
                        <button onClick={handleSubmit} className={`w-full text-white py-3 rounded-2xl font-bold shadow-sm active:scale-95 transition-all text-sm tracking-widest ${isLoan ? 'bg-[#dcb5bb]' : 'bg-[#a6b4c3] hover:bg-[#97a6b6]'}`}>
                            {isEditingTx ? 'Êõ¥Êñ∞Á¥ÄÈåÑ (UPDATE)' : (isLoan ? 'CONFIRM LOAN' : 'ADD EXPENSE')}
                        </button>
                    </Card>
                    <div className="space-y-4">
                        <div className="sticky top-0 bg-[#f7f5f4] z-10 py-3 space-y-2">
                            <div className="flex gap-2 px-1">
                                <div className="relative flex-1"><select value={displayedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="w-full appearance-none bg-white border border-stone-200 text-m-text py-2 pl-4 pr-8 rounded-xl text-sm font-bold focus:outline-none focus:border-[#dcb5bb] shadow-sm">{availableMonths.map(m => <option key={m} value={m}>{m}</option>)}</select><Icon name="calendar" size={14} className="absolute right-3 top-1/2 -translate-y-1/2 text-m-sub pointer-events-none"/></div>
                                <div className="relative flex-1"><select value={selectedCardFilter} onChange={(e) => setSelectedCardFilter(e.target.value)} className="w-full appearance-none bg-white border border-stone-200 text-m-text py-2 pl-4 pr-8 rounded-xl text-sm font-bold focus:outline-none focus:border-[#a6b4c3] shadow-sm"><option value="all">ÊâÄÊúâÊîØ‰ªò</option><option value="cash">üí∞ ÂÉÖÁèæÈáë</option>{cards.map(c => <option key={c.id} value={c.id}>üí≥ {c.name}</option>)}</select><Icon name="filter" size={14} className="absolute right-3 top-1/2 -translate-y-1/2 text-m-sub pointer-events-none"/></div>
                            </div>
                            <div className="flex justify-between items-center px-2"><div className="text-[10px] text-m-sub flex flex-col"><span className="font-bold">{filterDescription}</span><span className="opacity-70">Êú¨ÊúüÊáâÁπ≥Á∏ΩÈ°ç</span></div><div className="text-lg font-bold text-[#5e5a5a]">${currentMonthTotal.toLocaleString()}</div></div>
                        </div>
                        <div className="space-y-3 pb-24">
                            {currentMonthItems.length === 0 ? (<div className="text-center py-10 text-m-sub text-xs">Ê≠§ÂçÄÈñìÁÑ°Á¥ÄÈåÑ</div>) : (currentMonthItems.map((item) => (
                                <div key={item.id} className={`bg-white p-4 rounded-[20px] shadow-[0_2px_10px_-5px_rgba(0,0,0,0.03)] flex justify-between items-center border ${isEditingTx && input.id === item.id ? 'border-[#dcb5bb] ring-1 ring-[#dcb5bb]' : 'border-white'}`}>
                                    <div className="flex items-center gap-3">
                                        <div className={`p-3 rounded-full shrink-0 ${item.type === 'lending' ? 'bg-[#dcb5bb]/20 text-[#dcb5bb]' : item.method === 'Âà∑Âç°' ? 'bg-[#eaddcf]/30 text-[#cbbba9]' : 'bg-[#b5c4b1]/20 text-[#96a891]'}`}>{item.type === 'lending' ? <Icon name="heart-handshake" size={18}/> : item.method === 'Âà∑Âç°' ? <Icon name="credit-card" size={18}/> : <Icon name="banknote" size={18}/>}</div>
                                        <div><div className={`font-medium text-sm ${item.type === 'lending' ? 'text-m-pink' : 'text-m-text'}`}>{item.category}</div><div className="text-[10px] text-m-sub font-light">{item.date.slice(5)} {item.note && `¬∑ ${item.note}`} {item.method === 'Âà∑Âç°' && item.cardId && (<span className="ml-1 text-[#a6b4c3] bg-gray-50 px-1 rounded">{cards.find(c => c.id === item.cardId)?.name || 'Credit Card'}</span>)}</div></div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className={`font-medium text-sm ${item.type === 'lending' ? 'text-m-pink' : 'text-m-text'}`}>-${Number(item.amount).toLocaleString()}</span>
                                        <button onClick={() => startEditTransaction(item)} className="text-gray-300 hover:text-blue-400 p-1"><Icon name="pencil" size={16}/></button>
                                        <button onClick={() => onDelete(item.id)} className="text-gray-300 hover:text-red-400 p-1"><Icon name="trash-2" size={16}/></button>
                                    </div>
                                </div>
                            )))}
                        </div>
                    </div>
                </div>
            );
        };

        const NavBar = ({ activeTab, setActiveTab }) => (
            <div className="fixed bottom-6 left-6 right-6 bg-white/90 backdrop-blur-xl rounded-[30px] shadow-[0_8px_30px_rgba(0,0,0,0.08)] flex justify-between px-8 py-4 z-50 border border-white/50">
                <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center transition-all duration-300 ${activeTab === 'home' ? 'text-[#dcb5bb] scale-110' : 'text-[#d3d3d3] hover:text-[#b0b0b0]'}`}><Icon name="layout-dashboard" size={22}/></button>
                <button onClick={() => setActiveTab('savings')} className={`flex flex-col items-center transition-all duration-300 ${activeTab === 'savings' ? 'text-[#b5c4b1] scale-110' : 'text-[#d3d3d3] hover:text-[#b0b0b0]'}`}><Icon name="bar-chart-2" size={22}/></button>
                <button onClick={() => setActiveTab('expense')} className={`flex flex-col items-center transition-all duration-300 ${activeTab === 'expense' ? 'text-[#a6b4c3] scale-110' : 'text-[#d3d3d3] hover:text-[#b0b0b0]'}`}><Icon name="wallet" size={22}/></button>
                <button onClick={() => setActiveTab('analysis')} className={`flex flex-col items-center transition-all duration-300 ${activeTab === 'analysis' ? 'text-[#eaddcf] scale-110' : 'text-[#d3d3d3] hover:text-[#b0b0b0]'}`}><Icon name="pie-chart" size={22}/></button>
            </div>
        );

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [config, setConfig] = useState(() => safeStorage.get('richLadyConfigV3', { initialCash: 0, initialEtf: 0, initialDebt: 0, etfReturnRate: 6 }));
            const [transactions, setTransactions] = useState(() => safeStorage.get('richLadyTransactions', []));
            const [customCategories, setCustomCategories] = useState(() => safeStorage.get('richLadyCategories', ['Â®õÊ®Ç', 'È£≤È£ü', '‰∫§ÈÄö', '‰øùÈö™', 'ÈÜ´Áæé', 'Ê≤ªË£ù']));
            const [paidBills, setPaidBills] = useState(() => safeStorage.get('richLadyPaidBills', {}));
            
            const defaultCards = [
                { id: 'c1', name: '‰∏≠‰ø° Foodpanda', stmtDay: '15', dueDay: '3' },
                { id: 'c2', name: 'ÂúãÊ≥∞ Cube', stmtDay: '27', dueDay: '15' },
                { id: 'c3', name: 'ÂØåÈÇ¶ MOMO', stmtDay: '20', dueDay: '8' },
                { id: 'c4', name: 'ÂåØË±ê Live+', stmtDay: '10', dueDay: '28' },
                { id: 'c5', name: 'Âè∞Êñ∞ Richart', stmtDay: '12', dueDay: '27' },
            ];
            const [cards, setCards] = useState(() => safeStorage.get('richLadyCards', defaultCards));

            useEffect(() => { safeStorage.set('richLadyConfigV3', config); }, [config]);
            useEffect(() => { safeStorage.set('richLadyTransactions', transactions); }, [transactions]);
            useEffect(() => { safeStorage.set('richLadyCategories', customCategories); }, [customCategories]);
            useEffect(() => { safeStorage.set('richLadyCards', cards); }, [cards]);
            useEffect(() => { safeStorage.set('richLadyPaidBills', paidBills); }, [paidBills]);
            useEffect(() => { lucide.createIcons(); });

            const stats = useMemo(() => {
                let cashAssets = parseFloat(config.initialCash) || 0;
                let etfAssets = parseFloat(config.initialEtf) || 0;
                let currentDebt = parseFloat(config.initialDebt) || 0;
                
                transactions.forEach(t => {
                    const amt = parseFloat(t.amount) || 0;
                    if (t.type === 'deposit_cash') cashAssets += amt;
                    if (t.type === 'deposit_etf') etfAssets += amt;
                    if (t.type === 'repayment') { currentDebt -= amt; cashAssets += amt; }
                    if (t.type === 'lending') { cashAssets -= amt; currentDebt += amt; }
                });
                return { totalAssets: cashAssets + etfAssets, cashAssets, etfAssets, currentDebt };
            }, [config, transactions]);

            const projection = useMemo(() => {
                const targetDate = new Date('2027-12-31');
                const today = new Date();
                const monthsRemaining = Math.max(0, (targetDate.getFullYear() - today.getFullYear()) * 12 + (targetDate.getMonth() - today.getMonth()));
                const history = transactions.filter(t => ['deposit_cash', 'deposit_etf', 'repayment'].includes(t.type));
                let avgCashIn = 0, avgEtfIn = 0;
                if (history.length > 0) {
                    const uniqueMonths = new Set(history.map(t => t.date.substring(0, 7))).size || 1;
                    const totalCashIn = history.filter(t => t.type === 'deposit_cash' || t.type === 'repayment').reduce((acc, t) => acc + parseFloat(t.amount), 0);
                    const totalEtfIn = history.filter(t => t.type === 'deposit_etf').reduce((acc, t) => acc + parseFloat(t.amount), 0);
                    avgCashIn = totalCashIn / uniqueMonths;
                    avgEtfIn = totalEtfIn / uniqueMonths;
                }
                const futureCash = stats.cashAssets + (avgCashIn * monthsRemaining);
                const r = (parseFloat(config.etfReturnRate) || 0) / 100;
                const monthlyRate = r / 12;
                let futureEtf = 0;
                if (monthlyRate > 0) {
                    const principalFV = stats.etfAssets * Math.pow(1 + monthlyRate, monthsRemaining);
                    const annuityFV = avgEtfIn * (Math.pow(1 + monthlyRate, monthsRemaining) - 1) / monthlyRate;
                    futureEtf = principalFV + annuityFV;
                } else {
                    futureEtf = stats.etfAssets + (avgEtfIn * monthsRemaining);
                }
                return Math.floor(futureCash + futureEtf);
            }, [stats, transactions, config.etfReturnRate]);

            const handleSaveTransactions = (newItems, date) => {
                const itemsWithId = newItems.map((item, idx) => ({ id: Date.now() + idx, date, ...item, amount: parseFloat(item.amount) }));
                setTransactions([...transactions, ...itemsWithId]);
            };
            const handleSingleTransaction = (item) => { setTransactions([{...item, id: Date.now(), amount: parseFloat(item.amount)}, ...transactions]); };
            
            // New: Handle Update
            const handleUpdateTransaction = (updatedItem) => {
                setTransactions(transactions.map(t => t.id === updatedItem.id ? { ...t, ...updatedItem, amount: parseFloat(updatedItem.amount) } : t));
            };

            const handleDelete = (id) => { if(confirm("Delete this transaction?")) setTransactions(transactions.filter(t => t.id !== id)); };

            return (
                <div className="max-w-md mx-auto min-h-screen relative overflow-hidden bg-[#f7f5f4]">
                    <div className="pt-4 px-3">
                        {activeTab === 'home' && <HomeView stats={stats} projection={projection} config={config} setConfig={setConfig} onSaveTransactions={handleSaveTransactions}/>}
                        {activeTab === 'savings' && <SavingsView transactions={transactions} onDelete={handleDelete}/>}
                        {activeTab === 'expense' && (
                            <ExpenseView 
                                transactions={transactions} 
                                customCategories={customCategories} 
                                setCustomCategories={setCustomCategories} 
                                cards={cards} 
                                setCards={setCards} 
                                onSaveTransaction={handleSingleTransaction} 
                                onDelete={handleDelete}
                                paidBills={paidBills}
                                setPaidBills={setPaidBills}
                                onUpdateTransactions={handleUpdateTransaction}
                            />
                        )}
                        {activeTab === 'analysis' && <AnalysisView transactions={transactions} />}
                    </div>
                    <NavBar activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


