<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>77富婆計劃 V5.2</title>
    
    <!-- 1. 載入 CSS 與字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入核心程式庫 (使用最穩定的 cdnjs) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* 載入畫面樣式 */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f7f5f4; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; items-center;
            transition: opacity 0.5s;
        }
        .spinner {
            width: 40px; height: 40px; border: 3px solid #eaddcf;
            border-top: 3px solid #dcb5bb; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 全域變數 */
        :root {
            --morandi-pink: #dcb5bb;
            --morandi-bg: #f7f5f4;
            --morandi-text: #5e5a5a;
            --morandi-sub: #9e9a99;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--morandi-bg);
            color: var(--morandi-text);
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .page-transition { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        input, select {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            transition: all 0.3s;
        }
        input:focus, select:focus {
            background-color: #fff;
            border-color: var(--morandi-pink);
            outline: none;
            box-shadow: 0 0 0 2px rgba(220, 181, 187, 0.2);
        }
    </style>
</head>
<body>
    <!-- 3. 載入中畫面 (避免白屏) -->
    <div id="loader">
        <div class="spinner"></div>
        <div style="color: #9e9a99; font-size: 14px; letter-spacing: 1px;">LOADING...</div>
    </div>

    <div id="root"></div>

    <!-- 4. 錯誤捕捉機制 (如果當機，會顯示原因) -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const loader = document.getElementById('loader');
            if(loader) {
                loader.innerHTML = `
                    <div style="padding:30px; text-align:center; color:#5e5a5a;">
                        <h3 style="color:#dcb5bb; font-size:20px; margin-bottom:10px;">Oops! 發生錯誤</h3>
                        <p style="font-size:14px; margin-bottom:20px;">可能是網路載入失敗，請嘗試重新整理。</p>
                        <div style="background:#eee; padding:10px; border-radius:8px; font-size:10px; text-align:left; overflow:scroll; max-height:200px; color:#333;">
                            ${message}
                        </div>
                        <button onclick="location.reload()" style="margin-top:20px; background:#dcb5bb; color:white; border:none; padding:10px 25px; border-radius:20px;">重新整理</button>
                    </div>
                `;
            }
        };
    </script>

    <!-- 5. 主程式 -->
    <script type="text/babel">
        // 確保在 React 載入後移除 Loader
        setTimeout(() => {
            const loader = document.getElementById('loader');
            if(loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }
        }, 1000); // 最少顯示 1 秒

        const { useState, useEffect, useMemo } = React;
        const Icon = ({ name, size = 20, className = "" }) => <i data-lucide={name} width={size} height={size} className={className}></i>;
        const Card = ({ children, className = "" }) => <div className={`bg-white rounded-[24px] p-6 shadow-[0_4px_20px_-10px_rgba(0,0,0,0.05)] border border-stone-50 ${className}`}>{children}</div>;

        const safeStorage = {
            get: (key, fallback) => { try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : fallback; } catch (e) { return fallback; } },
            set: (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) {} }
        };

        const StackedBarChart = ({ data }) => {
            if (!data || data.length === 0) return <div className="text-m-sub text-center py-10 text-xs font-light tracking-widest">NO DATA YET</div>;
            const maxTotal = Math.max(...data.map(d => d.total)) || 1;
            const displayData = data.slice(0, 6).reverse(); 
            return (
                <div className="flex items-end justify-between h-40 pt-4 px-2 space-x-3 select-none">
                    {displayData.map((d, i) => {
                        const hCash = (d.cash / maxTotal) * 100;
                        const hEtf = (d.etf / maxTotal) * 100;
                        const hRepay = (d.repay / maxTotal) * 100;
                        return (
                            <div key={i} className="flex flex-col items-center flex-1 group relative">
                                <div className="w-full max-w-[32px] flex flex-col-reverse h-28 bg-[#f0f0f0] rounded-full overflow-hidden relative">
                                    <div style={{height: `${hRepay}%`}} className="bg-[#dcb5bb] w-full transition-all duration-500"></div>
                                    <div style={{height: `${hEtf}%`}} className="bg-[#a6b4c3] w-full transition-all duration-500"></div>
                                    <div style={{height: `${hCash}%`}} className="bg-[#b5c4b1] w-full transition-all duration-500"></div>
                                </div>
                                <div className="text-[10px] text-m-sub mt-2 font-medium tracking-wide">{d.month.split('-')[1]}月</div>
                            </div>
                        )
                    })}
                </div>
            );
        };

        const SimplePieChart = ({ data }) => {
            if (!data || data.length === 0) return <div className="text-m-sub text-center py-10 text-xs font-light tracking-widest">NO DATA</div>;
            const total = data.reduce((acc, item) => acc + item.value, 0);
            let cumulativePercent = 0;
            const palette = ['#dcb5bb', '#eaddcf', '#a6b4c3', '#b5c4b1', '#c7c7bb', '#d8d3cd', '#bfb5b2', '#9fa3a7'];
            const slices = data.map((slice, index) => {
                const startPercent = cumulativePercent;
                const slicePercent = slice.value / total;
                cumulativePercent += slicePercent;
                const endPercent = cumulativePercent;
                const x1 = Math.cos(2 * Math.PI * startPercent);
                const y1 = Math.sin(2 * Math.PI * startPercent);
                const x2 = Math.cos(2 * Math.PI * endPercent);
                const y2 = Math.sin(2 * Math.PI * endPercent);
                const largeArcFlag = slicePercent > 0.5 ? 1 : 0;
                const pathData = [`M 0 0`, `L ${x1} ${y1}`, `A 1 1 0 ${largeArcFlag} 1 ${x2} ${y2}`, `L 0 0`].join(' ');
                return <path d={pathData} fill={palette[index % palette.length]} key={index} stroke="#fff" strokeWidth="0.05" />;
            });
            return (
                <div className="flex flex-col items-center">
                    <div className="w-36 h-36 relative drop-shadow-sm">
                        <svg viewBox="-1 -1 2 2" style={{ transform: 'rotate(-90deg)' }}>{slices}</svg>
                    </div>
                    <div className="mt-6 grid grid-cols-2 gap-x-4 gap-y-2 w-full text-xs">
                        {data.map((item, index) => (
                            <div key={index} className="flex items-center justify-between">
                                <div className="flex items-center">
                                    <span className="w-2 h-2 rounded-full mr-2" style={{backgroundColor: palette[index % palette.length]}}></span>
                                    <span className="text-m-text truncate max-w-[80px]">{item.name}</span>
                                </div>
                                <span className="font-medium text-m-text">${item.value.toLocaleString()}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const HomeView = ({ stats, projection, config, setConfig, onSaveTransactions }) => {
            const [showSettings, setShowSettings] = useState(false);
            const [input, setInput] = useState({ depositCash: '', depositEtf: '', repayment: '' });

            const handleSubmit = () => {
                const newTrans = [];
                const today = new Date().toISOString().split('T')[0];
                if (input.depositCash) newTrans.push({ type: 'deposit_cash', amount: input.depositCash, note: '現金存入' });
                if (input.depositEtf) newTrans.push({ type: 'deposit_etf', amount: input.depositEtf, note: 'ETF存入' });
                if (input.repayment) newTrans.push({ type: 'repayment', amount: input.repayment, note: '男友還款' });
                if (newTrans.length > 0) {
                    onSaveTransactions(newTrans, today);
                    setInput({ depositCash: '', depositEtf: '', repayment: '' });
                }
            };
            const handleConfigChange = (e) => setConfig({ ...config, [e.target.name]: e.target.value });

            return (
                <div className="space-y-5 pb-48 page-transition">
                    <div className="bg-[#dcb5bb] rounded-[32px] p-8 text-white shadow-sm relative overflow-hidden mx-1">
                        <div className="absolute -top-10 -right-10 w-40 h-40 bg-white opacity-10 rounded-full blur-2xl"></div>
                        <div className="relative z-10">
                            <div className="text-white/80 text-xs font-medium tracking-widest mb-1 uppercase">Total Assets</div>
                            <div className="text-4xl font-light mb-6 tracking-tight">${stats.totalAssets.toLocaleString()}</div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><div className="text-[10px] text-white/70 uppercase tracking-wider mb-1">Portfolio (ETF)</div><div className="text-lg font-medium">${stats.etfAssets.toLocaleString()}</div></div>
                                <div><div className="text-[10px] text-white/70 uppercase tracking-wider mb-1">Cash</div><div className="text-lg font-medium">${stats.cashAssets.toLocaleString()}</div></div>
                            </div>
                            <div className="mt-6 pt-4 border-t border-white/20 flex justify-between items-center">
                                <div className="flex items-center text-white/90"><span className="text-xs mr-2">男友欠款總額</span><span className="font-medium text-lg">${stats.currentDebt.toLocaleString()}</span></div>
                                <Icon name="heart-handshake" className="text-white/80" />
                            </div>
                        </div>
                    </div>
                    <div className="px-2">
                         <div onClick={() => setShowSettings(!showSettings)} className="flex justify-center py-2 cursor-pointer opacity-50 hover:opacity-100 transition-opacity">
                            {showSettings ? <Icon name="chevron-up" size={16} className="text-m-text"/> : <Icon name="grip-horizontal" size={20} className="text-m-pink"/>}
                         </div>
                        {showSettings && (
                            <Card className="mb-4 animate-in slide-in-from-top-2 fade-in duration-300">
                                <h3 className="text-xs font-bold text-m-sub uppercase mb-4 tracking-widest text-center">Initial Settings</h3>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="col-span-2"><label className="block text-[10px] text-m-sub mb-1 ml-1">男友初始欠款</label><input type="number" name="initialDebt" value={config.initialDebt} onChange={handleConfigChange} className="w-full rounded-xl px-4 py-2 text-sm text-m-text" inputMode="numeric"/></div>
                                    <div><label className="block text-[10px] text-m-sub mb-1 ml-1">初始現金</label><input type="number" name="initialCash" value={config.initialCash} onChange={handleConfigChange} className="w-full rounded-xl px-4 py-2 text-sm text-m-text" inputMode="numeric"/></div>
                                    <div><label className="block text-[10px] text-m-sub mb-1 ml-1">初始 ETF</label><input type="number" name="initialEtf" value={config.initialEtf} onChange={handleConfigChange} className="w-full rounded-xl px-4 py-2 text-sm text-m-text" inputMode="numeric"/></div>
                                    <div className="col-span-2"><label className="block text-[10px] text-m-sub mb-1 ml-1 text-center">ETF 年化報酬率 (%)</label><input type="number" name="etfReturnRate" value={config.etfReturnRate} onChange={handleConfigChange} className="w-full rounded-xl px-4 py-2 text-sm text-m-text font-bold text-center text-[#a6b4c3]" inputMode="decimal"/></div>
                                </div>
                            </Card>
                        )}
                    </div>
                    <div className="px-1">
                        <h3 className="text-sm font-bold text-m-text mb-3 ml-2 tracking-wide">Monthly Checklist</h3>
                        <Card className="space-y-4">
                            {[
                                { label: '現金存入', icon: 'banknote', color: 'text-[#b5c4b1]', bg: 'bg-[#b5c4b1]/20', val: input.depositCash, key: 'depositCash' },
                                { label: 'ETF 投入', icon: 'landmark', color: 'text-[#a6b4c3]', bg: 'bg-[#a6b4c3]/20', val: input.depositEtf, key: 'depositEtf' },
                                { label: '男友還款', icon: 'user-minus', color: 'text-[#dcb5bb]', bg: 'bg-[#dcb5bb]/20', val: input.repayment, key: 'repayment' }
                            ].map((item, idx) => (
                                <div key={idx} className="flex items-center space-x-3">
                                    <div className={`p-2.5 rounded-xl ${item.bg} ${item.color}`}><Icon name={item.icon} size={18}/></div>
                                    <div className="flex-1">
                                        <label className="text-[10px] text-m-sub block mb-0.5">{item.label}</label>
                                        <input type="number" value={item.val} onChange={(e) => setInput({...input, [item.key]: e.target.value})} className="w-full bg-transparent border-b border-dashed border-gray-300 py-1 focus:border-solid focus:border-[#dcb5bb] outline-none font-medium text-m-text rounded-none px-0" placeholder="0" inputMode="numeric"/>
                                    </div>
                                </div>
                            ))}
                            <button onClick={handleSubmit} className="w-full bg-[#dcb5bb] hover:bg-[#d4a5a5] text-white py-3.5 rounded-2xl font-bold shadow-md active:scale-95 transition-all text-sm tracking-widest mt-2">SAVE ASSETS</button>
                        </Card>
                    </div>
                    <div className="fixed bottom-[80px] left-4 right-4 z-10">
                        <div className="bg-[#5e5a5a] text-white rounded-2xl p-4 shadow-xl flex justify-between items-center backdrop-blur-md bg-opacity-95">
                            <div><div className="text-[10px] text-white/50 tracking-widest uppercase">2027 Vision</div><div className="text-lg font-light tracking-wide">${projection.toLocaleString()}</div></div>
                            <div className="text-right flex flex-col items-end"><Icon name="trending-up" className="text-[#b5c4b1] mb-1" size={18}/><div className="text-[9px] text-white/40">@{config.etfReturnRate}% APY</div></div>
                        </div>
                    </div>
                </div>
            );
        };

        const ExpenseView = ({ transactions, customCategories, setCustomCategories, onSaveTransaction, onDelete }) => {
            const [input, setInput] = useState({ amount: '', method: '現金', category: '飲食', customCategory: '', note: '', date: new Date().toISOString().split('T')[0] });
            const [isAddingCategory, setIsAddingCategory] = useState(false);
            const [isLoan, setIsLoan] = useState(false);

            const handleSubmit = () => {
                if (!input.amount) return;
                let type = 'expense';
                let category = input.category;
                if (isLoan) { type = 'lending'; category = '男友借款'; } 
                else {
                    category = isAddingCategory ? input.customCategory : input.category;
                    if (isAddingCategory && category && !customCategories.includes(category)) { setCustomCategories([...customCategories, category]); }
                }
                const newTx = { type, amount: input.amount, method: input.method, category, date: input.date, note: input.note };
                onSaveTransaction(newTx);
                setInput({ ...input, amount: '', note: '', customCategory: '' });
                setIsAddingCategory(false);
                setIsLoan(false);
            };

            const expenseHistory = transactions.filter(t => t.type === 'expense' || t.type === 'lending');
            const grouped = expenseHistory.reduce((acc, curr) => {
                const month = curr.date.substring(0, 7);
                if (!acc[month]) acc[month] = [];
                acc[month].push(curr);
                return acc;
            }, {});

            return (
                <div className="space-y-6 pb-24 page-transition px-1 pt-4">
                    <h2 className="text-xl font-bold text-m-text ml-2 tracking-wide">Expenditure</h2>
                    <Card>
                        <div className="flex items-center justify-between mb-6 pb-4 border-b border-dashed border-gray-100">
                            <span className={`text-sm font-bold ${isLoan ? 'text-m-pink' : 'text-m-sub'}`}>這是男友借款？</span>
                            <div onClick={() => setIsLoan(!isLoan)} className={`w-12 h-7 rounded-full flex items-center p-1 cursor-pointer transition-all duration-300 ${isLoan ? 'bg-[#dcb5bb]' : 'bg-gray-200'}`}><div className={`bg-white w-5 h-5 rounded-full shadow-sm transition-all duration-300 ${isLoan ? 'translate-x-5' : 'translate-x-0'}`}></div></div>
                        </div>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div className="col-span-2"><label className="text-[10px] text-m-sub ml-1 uppercase tracking-wider">Amount</label><div className="relative mt-1"><span className="absolute left-3 top-3 text-m-sub font-light">$</span><input type="number" className="w-full rounded-2xl py-3 pl-8 pr-4 text-xl font-medium text-m-text" value={input.amount} onChange={(e) => setInput({...input, amount: e.target.value})} placeholder="0.00" inputMode="numeric"/></div></div>
                            {!isLoan && (
                                <>
                                    <div className="col-span-2">
                                        <label className="text-[10px] text-m-sub ml-1 uppercase tracking-wider">Category</label>
                                        {isAddingCategory ? (
                                            <div className="flex gap-2 mt-1"><input type="text" className="flex-1 rounded-xl px-3 py-2 text-sm" placeholder="輸入分類" value={input.customCategory} onChange={(e) => setInput({...input, customCategory: e.target.value})} /><button onClick={() => setIsAddingCategory(false)} className="bg-gray-200 text-gray-500 px-3 rounded-xl text-xs">取消</button></div>
                                        ) : (
                                            <div className="mt-1"><select className="w-full rounded-xl px-3 py-2.5 text-sm text-m-text" value={input.category} onChange={(e) => { if (e.target.value === 'custom') { setIsAddingCategory(true); setInput({...input, customCategory: ''}); } else { setInput({...input, category: e.target.value}); } }}>{customCategories.map(c => <option key={c} value={c}>{c}</option>)}<option value="custom">+ 自訂分類</option></select></div>
                                        )}
                                    </div>
                                    <div><label className="text-[10px] text-m-sub ml-1 uppercase tracking-wider">Method</label><select className="w-full rounded-xl px-3 py-2 text-sm text-m-text mt-1" value={input.method} onChange={(e) => setInput({...input, method: e.target.value})}><option value="現金">現金</option><option value="刷卡">刷卡</option></select></div>
                                </>
                            )}
                            <div className={isLoan ? "col-span-2" : ""}><label className="text-[10px] text-m-sub ml-1 uppercase tracking-wider">Date</label><input type="date" className="w-full rounded-xl px-3 py-2 text-sm text-m-text mt-1" value={input.date} onChange={(e) => setInput({...input, date: e.target.value})} /></div>
                        </div>
                        <div className="mb-4"><input type="text" placeholder="Add a note..." className="w-full bg-transparent border-b border-gray-100 py-2 text-sm text-m-text placeholder-gray-300 focus:border-[#dcb5bb] outline-none" value={input.note} onChange={(e) => setInput({...input, note: e.target.value})} /></div>
                        <button onClick={handleSubmit} className={`w-full text-white py-3 rounded-2xl font-bold shadow-sm active:scale-95 transition-all text-sm tracking-widest ${isLoan ? 'bg-[#dcb5bb]' : 'bg-[#a6b4c3] hover:bg-[#97a6b6]'}`}>{isLoan ? 'CONFIRM LOAN' : 'ADD EXPENSE'}</button>
                    </Card>
                    <div className="space-y-6">
                        {Object.keys(grouped).sort().reverse().map(month => (
                            <div key={month}>
                                <h3 className="text-xs font-bold text-m-sub mb-3 ml-2 sticky top-0 bg-[#f7f5f4] z-10 py-2">{month}</h3>
                                <div className="space-y-3">
                                    {grouped[month].sort((a,b) => b.id - a.id).map((item) => (
                                        <div key={item.id} className="bg-white p-4 rounded-[20px] shadow-[0_2px_10px_-5px_rgba(0,0,0,0.03)] flex justify-between items-center border border-white">
                                            <div className="flex items-center gap-3">
                                                <div className={`p-3 rounded-full shrink-0 ${item.type === 'lending' ? 'bg-[#dcb5bb]/20 text-[#dcb5bb]' : item.method === '刷卡' ? 'bg-[#eaddcf]/30 text-[#cbbba9]' : 'bg-[#b5c4b1]/20 text-[#96a891]'}`}>{item.type === 'lending' ? <Icon name="heart-handshake" size={18}/> : item.method === '刷卡' ? <Icon name="credit-card" size={18}/> : <Icon name="banknote" size={18}/>}</div>
                                                <div><div className={`font-medium text-sm ${item.type === 'lending' ? 'text-m-pink' : 'text-m-text'}`}>{item.category}</div><div className="text-[10px] text-m-sub font-light">{item.date.slice(5)} {item.note && `· ${item.note}`}</div></div>
                                            </div>
                                            <div className="flex items-center gap-3"><span className={`font-medium text-sm ${item.type === 'lending' ? 'text-m-pink' : 'text-m-text'}`}>-${Number(item.amount).toLocaleString()}</span><button onClick={() => onDelete(item.id)} className="text-gray-200 hover:text-[#dcb5bb] transition-colors"><Icon name="trash-2" size={16}/></button></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const AnalysisView = ({ transactions }) => {
            const today = new Date();
            const currentMonthKey = today.toISOString().slice(0, 7);
            const expenses = transactions.filter(t => t.type === 'expense');
            const getMonthData = (monthKey) => expenses.filter(t => t.date.startsWith(monthKey));
            const currentTotal = getMonthData(currentMonthKey).reduce((a, c) => a + parseFloat(c.amount), 0);
            const categoryData = getMonthData(currentMonthKey).reduce((acc, curr) => {
                const existing = acc.find(i => i.name === curr.category);
                if (existing) existing.value += parseFloat(curr.amount); else acc.push({ name: curr.category, value: parseFloat(curr.amount) });
                return acc;
            }, []).sort((a,b) => b.value - a.value);

            return (
                <div className="space-y-6 pb-24 page-transition px-1 pt-4">
                    <h2 className="text-xl font-bold text-m-text ml-2 tracking-wide">Analytics</h2>
                    <Card className="bg-[#a6b4c3] border-none text-white">
                        <div className="flex justify-between items-start mb-6">
                            <div><div className="text-white/60 text-xs tracking-widest uppercase mb-1">Spending this month</div><div className="text-3xl font-light">${currentTotal.toLocaleString()}</div></div>
                            <div className="bg-white/20 p-2 rounded-xl"><Icon name="pie-chart" className="text-white"/></div>
                        </div>
                        <div className="text-[10px] text-white/50">* 不含男友借款 (借款屬資產轉移)</div>
                    </Card>
                    <Card><h3 className="text-xs font-bold text-m-sub text-center mb-6 tracking-widest uppercase">Category Breakdown</h3><SimplePieChart data={categoryData} /></Card>
                </div>
            );
        };

        const SavingsView = ({ transactions, onDelete }) => {
            const [filterMonth, setFilterMonth] = useState('all');
            const savingsHistory = useMemo(() => transactions.filter(t => ['deposit_cash', 'deposit_etf', 'repayment'].includes(t.type)), [transactions]);
            const availableMonths = useMemo(() => {
                const months = new Set(savingsHistory.map(t => t.date.substring(0, 7)));
                return Array.from(months).sort().reverse();
            }, [savingsHistory]);
            const chartData = useMemo(() => {
                const grouped = savingsHistory.reduce((acc, curr) => {
                    const m = curr.date.substring(0, 7);
                    if (!acc[m]) acc[m] = { month: m, cash: 0, etf: 0, repay: 0, total: 0 };
                    const amt = parseFloat(curr.amount);
                    if (curr.type === 'deposit_cash') acc[m].cash += amt;
                    if (curr.type === 'deposit_etf') acc[m].etf += amt;
                    if (curr.type === 'repayment') acc[m].repay += amt;
                    acc[m].total += amt;
                    return acc;
                }, {});
                return Object.values(grouped).sort((a,b) => a.month.localeCompare(b.month));
            }, [savingsHistory]);
            const displayedRecords = useMemo(() => {
                const filtered = filterMonth === 'all' ? savingsHistory : savingsHistory.filter(t => t.date.startsWith(filterMonth));
                const groupedByMonth = filtered.reduce((acc, curr) => {
                    const m = curr.date.substring(0, 7);
                    if (!acc[m]) acc[m] = [];
                    acc[m].push(curr);
                    return acc;
                }, {});
                return Object.keys(groupedByMonth).sort().reverse().map(month => ({ month, items: groupedByMonth[month].sort((a, b) => b.id - a.id) }));
            }, [savingsHistory, filterMonth]);

            return (
                <div className="space-y-6 pb-24 page-transition px-1 pt-4">
                    <div className="flex justify-between items-center px-2">
                        <h2 className="text-xl font-bold text-m-text tracking-wide">Savings</h2>
                        <div className="relative">
                            <select value={filterMonth} onChange={(e) => setFilterMonth(e.target.value)} className="appearance-none bg-white border border-stone-200 text-m-sub py-1.5 pl-4 pr-8 rounded-full text-xs font-medium focus:outline-none focus:border-[#dcb5bb]"><option value="all">All Time</option>{availableMonths.map(m => <option key={m} value={m}>{m}</option>)}</select>
                            <Icon name="chevron-down" size={14} className="absolute right-3 top-1/2 -translate-y-1/2 text-m-sub pointer-events-none"/>
                        </div>
                    </div>
                    <Card><h3 className="text-xs font-bold text-m-sub mb-2 ml-1 tracking-widest uppercase">Trend (6 Months)</h3><StackedBarChart data={chartData} /></Card>
                    <div className="space-y-4">
                         {displayedRecords.map(({ month, items }) => (
                            <div key={month}>
                                <div className="sticky top-0 bg-[#f7f5f4] z-10 py-2 mb-1 px-2"><span className="text-xs font-bold text-m-sub">{month}</span></div>
                                <div className="space-y-3">
                                    {items.map(item => (
                                        <div key={item.id} className="bg-white p-4 rounded-[20px] shadow-[0_2px_10px_-5px_rgba(0,0,0,0.03)] flex justify-between items-center border border-white">
                                            <div className="flex items-center gap-3">
                                                <div className={`p-3 rounded-full shrink-0 ${item.type==='deposit_cash' ? 'bg-[#b5c4b1]/20 text-[#8a9986]' : item.type==='deposit_etf' ? 'bg-[#a6b4c3]/20 text-[#8594a3]' : 'bg-[#dcb5bb]/20 text-[#bc969c]'}`}>{item.type==='deposit_cash' ? <Icon name="banknote" size={18}/> : item.type==='deposit_etf' ? <Icon name="landmark" size={18}/> : <Icon name="user-minus" size={18}/>}</div>
                                                <div><div className="font-medium text-sm text-m-text">{item.type==='deposit_cash' ? 'Cash Deposit' : item.type==='deposit_etf' ? 'ETF Invest' : 'Repayment'}</div><div className="text-[10px] text-m-sub font-light">{item.date} {item.note && `· ${item.note}`}</div></div>
                                            </div>
                                            <div className="flex items-center gap-3"><span className="font-medium text-sm text-m-text">+${Number(item.amount).toLocaleString()}</span><button onClick={() => onDelete(item.id)} className="text-gray-200 hover:text-[#dcb5bb] transition-colors"><Icon name="trash-2" size={16}/></button></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const NavBar = ({ activeTab, setActiveTab }) => (
            <div className="fixed bottom-6 left-6 right-6 bg-white/90 backdrop-blur-xl rounded-[30px] shadow-[0_8px_30px_rgba(0,0,0,0.08)] flex justify-between px-8 py-4 z-50 border border-white/50">
                <button onClick={() => setActiveTab('home')} className={`flex flex-col items-center transition-all duration-300 ${activeTab === 'home' ? 'text-[#dcb5bb] scale-110' : 'text-[#d3d3d3] hover:text-[#b0b0b0]'}`}><Icon name="layout-dashboard" size={22}/></button>
                <button onClick={() => setActiveTab('savings')} className={`flex flex-col items-center transition-all duration-300 ${activeTab === 'savings' ? 'text-[#b5c4b1] scale-110' : 'text-[#d3d3d3] hover:text-[#b0b0b0]'}`}><Icon name="bar-chart-2" size={22}/></button>
                <button onClick={() => setActiveTab('expense')} className={`flex flex-col items-center transition-all duration-300 ${activeTab === 'expense' ? 'text-[#a6b4c3] scale-110' : 'text-[#d3d3d3] hover:text-[#b0b0b0]'}`}><Icon name="wallet" size={22}/></button>
                <button onClick={() => setActiveTab('analysis')} className={`flex flex-col items-center transition-all duration-300 ${activeTab === 'analysis' ? 'text-[#eaddcf] scale-110' : 'text-[#d3d3d3] hover:text-[#b0b0b0]'}`}><Icon name="pie-chart" size={22}/></button>
            </div>
        );

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [config, setConfig] = useState(() => safeStorage.get('richLadyConfigV3', { initialCash: 0, initialEtf: 0, initialDebt: 0, etfReturnRate: 6 }));
            const [transactions, setTransactions] = useState(() => safeStorage.get('richLadyTransactions', []));
            const [customCategories, setCustomCategories] = useState(() => safeStorage.get('richLadyCategories', ['娛樂', '飲食', '交通', '保險', '醫美', '治裝']));
            useEffect(() => { safeStorage.set('richLadyConfigV3', config); }, [config]);
            useEffect(() => { safeStorage.set('richLadyTransactions', transactions); }, [transactions]);
            useEffect(() => { safeStorage.set('richLadyCategories', customCategories); }, [customCategories]);
            useEffect(() => { lucide.createIcons(); });

            const stats = useMemo(() => {
                let cashAssets = parseFloat(config.initialCash) || 0;
                let etfAssets = parseFloat(config.initialEtf) || 0;
                let currentDebt = parseFloat(config.initialDebt) || 0;
                transactions.forEach(t => {
                    const amt = parseFloat(t.amount) || 0;
                    if (t.type === 'deposit_cash') cashAssets += amt;
                    if (t.type === 'deposit_etf') etfAssets += amt;
                    if (t.type === 'repayment') { currentDebt -= amt; cashAssets += amt; }
                    if (t.type === 'lending') { cashAssets -= amt; currentDebt += amt; }
                });
                return { totalAssets: cashAssets + etfAssets, cashAssets, etfAssets, currentDebt };
            }, [config, transactions]);

            const projection = useMemo(() => {
                const targetDate = new Date('2027-12-31');
                const today = new Date();
                const monthsRemaining = Math.max(0, (targetDate.getFullYear() - today.getFullYear()) * 12 + (targetDate.getMonth() - today.getMonth()));
                const history = transactions.filter(t => ['deposit_cash', 'deposit_etf', 'repayment'].includes(t.type));
                let avgCashIn = 0, avgEtfIn = 0;
                if (history.length > 0) {
                    const uniqueMonths = new Set(history.map(t => t.date.substring(0, 7))).size || 1;
                    const totalCashIn = history.filter(t => t.type === 'deposit_cash' || t.type === 'repayment').reduce((acc, t) => acc + parseFloat(t.amount), 0);
                    const totalEtfIn = history.filter(t => t.type === 'deposit_etf').reduce((acc, t) => acc + parseFloat(t.amount), 0);
                    avgCashIn = totalCashIn / uniqueMonths;
                    avgEtfIn = totalEtfIn / uniqueMonths;
                }
                const futureCash = stats.cashAssets + (avgCashIn * monthsRemaining);
                const r = (parseFloat(config.etfReturnRate) || 0) / 100;
                const monthlyRate = r / 12;
                let futureEtf = 0;
                if (monthlyRate > 0) {
                    const principalFV = stats.etfAssets * Math.pow(1 + monthlyRate, monthsRemaining);
                    const annuityFV = avgEtfIn * (Math.pow(1 + monthlyRate, monthsRemaining) - 1) / monthlyRate;
                    futureEtf = principalFV + annuityFV;
                } else {
                    futureEtf = stats.etfAssets + (avgEtfIn * monthsRemaining);
                }
                return Math.floor(futureCash + futureEtf);
            }, [stats, transactions, config.etfReturnRate]);

            const handleSaveTransactions = (newItems, date) => {
                const itemsWithId = newItems.map((item, idx) => ({ id: Date.now() + idx, date, ...item, amount: parseFloat(item.amount) }));
                setTransactions([...transactions, ...itemsWithId]);
            };
            const handleSingleTransaction = (item) => { setTransactions([{...item, id: Date.now(), amount: parseFloat(item.amount)}, ...transactions]); };
            const handleDelete = (id) => { if(confirm("Delete this transaction?")) setTransactions(transactions.filter(t => t.id !== id)); };

            return (
                <div className="max-w-md mx-auto min-h-screen relative overflow-hidden bg-[#f7f5f4]">
                    <div className="pt-4 px-3">
                        {activeTab === 'home' && <HomeView stats={stats} projection={projection} config={config} setConfig={setConfig} onSaveTransactions={handleSaveTransactions}/>}
                        {activeTab === 'savings' && <SavingsView transactions={transactions} onDelete={handleDelete}/>}
                        {activeTab === 'expense' && <ExpenseView transactions={transactions} customCategories={customCategories} setCustomCategories={setCustomCategories} onSaveTransaction={handleSingleTransaction} onDelete={handleDelete}/>}
                        {activeTab === 'analysis' && <AnalysisView transactions={transactions} />}
                    </div>
                    <NavBar activeTab={activeTab} setActiveTab={setActiveTab} />
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>


